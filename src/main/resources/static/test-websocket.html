<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 테스트 도구</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; height: 200px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input[type="text"] { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { margin: 5px 0; padding: 5px; border-radius: 3px; }
        .sent { background-color: #e3f2fd; }
        .received { background-color: #f3e5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket 테스트 도구 (Postman 대체)</h1>
        
        <div class="section">
            <h3>연결 설정</h3>
            <input type="text" id="url" value="ws://localhost:8080/ws-stomp" style="width: 300px;">
            <button onclick="connect()">연결</button>
            <button onclick="disconnect()">연결 해제</button>
            <div id="status" class="status disconnected">연결되지 않음</div>
        </div>
        
        <div class="section">
            <h3>STOMP 프레임 전송</h3>
            <button onclick="sendConnect()">CONNECT</button>
            <button onclick="sendSubscribe()">SUBSCRIBE</button>
            <button onclick="sendMessage()">SEND 메시지</button>
            <button onclick="sendCustom()">사용자 정의 전송</button>
        </div>
        
        <div class="section">
            <h3>사용자 정의 메시지</h3>
            <textarea id="customMessage" rows="3" style="width: 100%; padding: 8px;">SEND
destination:/pub/chat/message
content-type:application/json

{"type":"TALK", "roomId":"room1", "sender":"tester", "message":"안녕하세요!"}
^@</textarea>
        </div>
        
        <div class="section">
            <h3>로그</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">로그 지우기</button>
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;

        function connect() {
            const url = document.getElementById('url').value;
            if (!url) {
                alert('URL을 입력하세요');
                return;
            }

            socket = new WebSocket(url);
            
            socket.onopen = function() {
                log('WebSocket 연결됨: ' + url, 'connected');
                updateStatus('연결됨', true);
                isConnected = true;
            };
            
            socket.onmessage = function(event) {
                log('서버 응답: ' + event.data, 'received');
            };
            
            socket.onclose = function(event) {
                log('WebSocket 연결 해제: ' + event.code + ' ' + event.reason, 'disconnected');
                updateStatus('연결 해제됨', false);
                isConnected = false;
            };
            
            socket.onerror = function(error) {
                log('WebSocket 에러: ' + error, 'error');
                updateStatus('연결 에러', false);
                isConnected = false;
            };
        }

        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
                isConnected = false;
                updateStatus('연결 해제됨', false);
            }
        }

        function sendConnect() {
            if (!isConnected) {
                alert('먼저 연결하세요');
                return;
            }
            
            const message = 'CONNECT\naccept-version:1.1,1.0\nheart-beat:10000,10000\n\n\x00';
            socket.send(message);
            log('CONNECT 프레임 전송', 'sent');
        }

        function sendSubscribe() {
            if (!isConnected) {
                alert('먼저 연결하세요');
                return;
            }
            
            const message = 'SUBSCRIBE\nid:sub-1\ndestination:/sub/chat/room/room1\n\n\x00';
            socket.send(message);
            log('SUBSCRIBE 프레임 전송', 'sent');
        }

        function sendMessage() {
            if (!isConnected) {
                alert('먼저 연결하세요');
                return;
            }
            
            const message = 'SEND\ndestination:/pub/chat/message\ncontent-type:application/json\n\n{"type":"ENTER", "roomId":"room1", "sender":"tester", "message":""}\x00';
            socket.send(message);
            log('SEND 프레임 전송', 'sent');
        }

        function sendCustom() {
            if (!isConnected) {
                alert('먼저 연결하세요');
                return;
            }
            
            let message = document.getElementById('customMessage').value;
            
            // 디버깅을 위한 로그
            log('원본 메시지: ' + JSON.stringify(message), 'debug');
            
            // ^@ 문자를 실제 널 바이트로 변환
            message = message.replace(/\^@/g, '\x00');
            
            // 변환된 메시지 로그
            log('변환된 메시지: ' + JSON.stringify(message), 'debug');
            
            socket.send(message);
            log('사용자 정의 메시지 전송', 'sent');
        }

        function updateStatus(message, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }

        function log(message, type) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'message ' + type;
            logEntry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
    </script>
</body>
</html>
